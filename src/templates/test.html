<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Collapsible Tree Example</title>

    <style>
      .node {
        cursor: pointer;
      }
      .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1.5px;
      }
      .node text {
        font: 10px sans-serif;
      }
      .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
      }

      body {
        overflow: hidden;
      }
    </style>
  </head>

  <body>
    <div id="body" style="border: 2px solid black"></div>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script>
      var margin = {
          top: 20,
          right: 120,
          bottom: 20,
          left: 120,
        },
        width = 960 - margin.right - margin.left,
        height = 800 - margin.top - margin.bottom;

      let root = {
        children: [
          {
            children: [
              {
                children: [
                  {
                    children: [
                      {
                        children: [
                          {
                            children: [
                              {
                                children: [
                                  {
                                    children: [],
                                    cost: [0, 33907.5],
                                    id: 7,
                                    rows: 624938,
                                    secondary_content: ["o_totalprice > '10'"],
                                    table: "orders",
                                    title: "Parallel Seq Scan",
                                    width: 16,
                                  },
                                  {
                                    children: [
                                      {
                                        children: [],
                                        cost: [0, 4366.25],
                                        id: 9,
                                        rows: 12648,
                                        secondary_content: [
                                          "c_mktsegment = 'BUILDING'",
                                        ],
                                        table: "customer",
                                        title: "Parallel Seq Scan",
                                        width: 4,
                                      },
                                    ],
                                    cost: [4366.25, 4366.25],
                                    id: 8,
                                    rows: 12648,
                                    secondary_content: [],
                                    table: null,
                                    title: "Parallel Hash",
                                    width: 4,
                                  },
                                ],
                                cost: [4524.35, 40072.36],
                                id: 6,
                                rows: 126467,
                                secondary_content: [
                                  "orders.o_custkey = customer.c_custkey",
                                ],
                                table: null,
                                title: "Parallel Hash Join",
                                width: 12,
                              },
                              {
                                children: [],
                                cost: [0.43, 1.11],
                                id: 10,
                                rows: 16,
                                secondary_content: [
                                  "l_orderkey = orders.o_orderkey",
                                  "l_extendedprice > '10'",
                                ],
                                table: "lineitem",
                                title: "Index Scan using lineitem_pkey",
                                width: 16,
                              },
                            ],
                            cost: [4524.78, 201208.53],
                            id: 5,
                            rows: 505894,
                            secondary_content: [],
                            table: null,
                            title: "Nested Loop",
                            width: 24,
                          },
                        ],
                        cost: [259515.64, 260780.37],
                        id: 4,
                        rows: 505894,
                        secondary_content: [
                          "lineitem.l_orderkey, orders.o_orderdate, orders.o_shippriority",
                        ],
                        table: null,
                        title: "Sort",
                        width: 24,
                      },
                    ],
                    cost: [259515.64, 274692.46],
                    id: 3,
                    rows: 505894,
                    secondary_content: [
                      "lineitem.l_orderkey, orders.o_orderdate, orders.o_shippriority",
                    ],
                    table: null,
                    title: "Partial GroupAggregate",
                    width: 44,
                  },
                ],
                cost: [260515.66, 392477.92],
                id: 2,
                rows: 1011788,
                secondary_content: ["Workers Planned: 2"],
                table: null,
                title: "Gather Merge",
                width: 44,
              },
            ],
            cost: [260515.66, 420302.08],
            id: 1,
            rows: 1214145,
            secondary_content: [
              "lineitem.l_orderkey, orders.o_orderdate, orders.o_shippriority",
            ],
            table: null,
            title: "Finalize GroupAggregate",
            width: 44,
          },
        ],
        cost: [617704.6, 620739.96],
        id: 0,
        rows: 1214145,
        secondary_content: [
          "(sum((lineitem.l_extendedprice * ('1' - lineitem.l_discount)))) DESC, orders.o_orderdate",
        ],
        table: null,
        title: "Sort",
        width: 44,
      };
      var root2 = {
        name: "flare",
        children: [
          {
            name: "analytics",
            children: [
              {
                name: "cluster",
                children: [
                  {
                    name: "AgglomerativeCluster",
                  },
                  {
                    name: "CommunityStructure",
                  },
                  {
                    name: "HierarchicalCluster",
                  },
                  {
                    name: "MergeEdge",
                  },
                ],
              },
              {
                name: "graph",
                children: [
                  {
                    name: "BetweennessCentrality",
                  },
                  {
                    name: "LinkDistance",
                  },
                  {
                    name: "MaxFlowMinCut",
                  },
                  {
                    name: "ShortestPaths",
                  },
                  {
                    name: "SpanningTree",
                  },
                ],
              },
              {
                name: "optimization",
                children: [
                  {
                    name: "AspectRatioBanker",
                  },
                ],
              },
            ],
          },
          {
            name: "animate",
            children: [
              {
                name: "Easing",
              },
              {
                name: "FunctionSequence",
              },
              {
                name: "interpolate",
                children: [
                  {
                    name: "ArrayInterpolator",
                  },
                  {
                    name: "ColorInterpolator",
                  },
                  {
                    name: "DateInterpolator",
                  },
                  {
                    name: "Interpolator",
                  },
                  {
                    name: "MatrixInterpolator",
                  },
                  {
                    name: "NumberInterpolator",
                  },
                  {
                    name: "ObjectInterpolator",
                  },
                  {
                    name: "PointInterpolator",
                  },
                  {
                    name: "RectangleInterpolator",
                  },
                ],
              },
              {
                name: "ISchedulable",
              },
              {
                name: "Parallel",
              },
              {
                name: "Pause",
              },
              {
                name: "Scheduler",
              },
              {
                name: "Sequence",
              },
              {
                name: "Transition",
              },
              {
                name: "Transitioner",
              },
              {
                name: "TransitionEvent",
              },
              {
                name: "Tween",
              },
            ],
          },
          {
            name: "data",
            children: [
              {
                name: "converters",
                children: [
                  {
                    name: "Converters",
                  },
                  {
                    name: "DelimitedTextConverter",
                  },
                  {
                    name: "GraphMLConverter",
                  },
                  {
                    name: "IDataConverter",
                  },
                  {
                    name: "JSONConverter",
                  },
                ],
              },
              {
                name: "DataField",
              },
              {
                name: "DataSchema",
              },
              {
                name: "DataSet",
              },
              {
                name: "DataSource",
              },
              {
                name: "DataTable",
              },
              {
                name: "DataUtil",
              },
            ],
          },
          {
            name: "display",
            children: [
              {
                name: "DirtySprite",
              },
              {
                name: "LineSprite",
              },
              {
                name: "RectSprite",
              },
              {
                name: "TextSprite",
              },
            ],
          },
          {
            name: "flex",
            children: [
              {
                name: "FlareVis",
              },
            ],
          },
          {
            name: "physics",
            children: [
              {
                name: "DragForce",
              },
              {
                name: "GravityForce",
              },
              {
                name: "IForce",
              },
              {
                name: "NBodyForce",
              },
              {
                name: "Particle",
              },
              {
                name: "Simulation",
              },
              {
                name: "Spring",
              },
              {
                name: "SpringForce",
              },
            ],
          },
          {
            name: "query",
            children: [
              {
                name: "AggregateExpression",
              },
              {
                name: "And",
              },
              {
                name: "Arithmetic",
              },
              {
                name: "Average",
              },
              {
                name: "BinaryExpression",
              },
              {
                name: "Comparison",
              },
              {
                name: "CompositeExpression",
              },
              {
                name: "Count",
              },
              {
                name: "DateUtil",
              },
              {
                name: "Distinct",
              },
              {
                name: "Expression",
              },
              {
                name: "ExpressionIterator",
              },
              {
                name: "Fn",
              },
              {
                name: "If",
              },
              {
                name: "IsA",
              },
              {
                name: "Literal",
              },
              {
                name: "Match",
              },
              {
                name: "Maximum",
              },
              {
                name: "methods",
                children: [
                  {
                    name: "add",
                  },
                  {
                    name: "and",
                  },
                  {
                    name: "average",
                  },
                  {
                    name: "count",
                  },
                  {
                    name: "distinct",
                  },
                  {
                    name: "div",
                  },
                  {
                    name: "eq",
                  },
                  {
                    name: "fn",
                  },
                  {
                    name: "gt",
                  },
                  {
                    name: "gte",
                  },
                  {
                    name: "iff",
                  },
                  {
                    name: "isa",
                  },
                  {
                    name: "lt",
                  },
                  {
                    name: "lte",
                  },
                  {
                    name: "max",
                  },
                  {
                    name: "min",
                  },
                  {
                    name: "mod",
                  },
                  {
                    name: "mul",
                  },
                  {
                    name: "neq",
                  },
                  {
                    name: "not",
                  },
                  {
                    name: "or",
                  },
                  {
                    name: "orderby",
                  },
                  {
                    name: "range",
                  },
                  {
                    name: "select",
                  },
                  {
                    name: "stddev",
                  },
                  {
                    name: "sub",
                  },
                  {
                    name: "sum",
                  },
                  {
                    name: "update",
                  },
                  {
                    name: "variance",
                  },
                  {
                    name: "where",
                  },
                  {
                    name: "xor",
                  },
                  {
                    name: "_",
                  },
                ],
              },
              {
                name: "Minimum",
              },
              {
                name: "Not",
              },
              {
                name: "Or",
              },
              {
                name: "Query",
              },
              {
                name: "Range",
              },
              {
                name: "StringUtil",
              },
              {
                name: "Sum",
              },
              {
                name: "Variable",
              },
              {
                name: "Variance",
              },
              {
                name: "Xor",
              },
            ],
          },
          {
            name: "scale",
            children: [
              {
                name: "IScaleMap",
              },
              {
                name: "LinearScale",
              },
              {
                name: "LogScale",
              },
              {
                name: "OrdinalScale",
              },
              {
                name: "QuantileScale",
              },
              {
                name: "QuantitativeScale",
              },
              {
                name: "RootScale",
              },
              {
                name: "Scale",
              },
              {
                name: "ScaleType",
              },
              {
                name: "TimeScale",
              },
            ],
          },
          {
            name: "util",
            children: [
              {
                name: "Arrays",
              },
              {
                name: "Colors",
              },
              {
                name: "Dates",
              },
              {
                name: "Displays",
              },
              {
                name: "Filter",
              },
              {
                name: "Geometry",
              },
              {
                name: "heap",
                children: [
                  {
                    name: "FibonacciHeap",
                  },
                  {
                    name: "HeapNode",
                  },
                ],
              },
              {
                name: "IEvaluable",
              },
              {
                name: "IPredicate",
              },
              {
                name: "IValueProxy",
              },
              {
                name: "math",
                children: [
                  {
                    name: "DenseMatrix",
                  },
                  {
                    name: "IMatrix",
                  },
                  {
                    name: "SparseMatrix",
                  },
                ],
              },
              {
                name: "Maths",
              },
              {
                name: "Orientation",
              },
              {
                name: "palette",
                children: [
                  {
                    name: "ColorPalette",
                  },
                  {
                    name: "Palette",
                  },
                  {
                    name: "ShapePalette",
                  },
                  {
                    name: "SizePalette",
                  },
                ],
              },
              {
                name: "Property",
              },
              {
                name: "Shapes",
              },
              {
                name: "Sort",
              },
              {
                name: "Stats",
              },
              {
                name: "Strings",
              },
            ],
          },
          {
            name: "vis",
            children: [
              {
                name: "axis",
                children: [
                  {
                    name: "Axes",
                  },
                  {
                    name: "Axis",
                  },
                  {
                    name: "AxisGridLine",
                  },
                  {
                    name: "AxisLabel",
                  },
                  {
                    name: "CartesianAxes",
                  },
                ],
              },
              {
                name: "controls",
                children: [
                  {
                    name: "AnchorControl",
                  },
                  {
                    name: "ClickControl",
                  },
                  {
                    name: "Control",
                  },
                  {
                    name: "ControlList",
                  },
                  {
                    name: "DragControl",
                  },
                  {
                    name: "ExpandControl",
                  },
                  {
                    name: "HoverControl",
                  },
                  {
                    name: "IControl",
                  },
                  {
                    name: "PanZoomControl",
                  },
                  {
                    name: "SelectionControl",
                  },
                  {
                    name: "TooltipControl",
                  },
                ],
              },
              {
                name: "data",
                children: [
                  {
                    name: "Data",
                  },
                  {
                    name: "DataList",
                  },
                  {
                    name: "DataSprite",
                  },
                  {
                    name: "EdgeSprite",
                  },
                  {
                    name: "NodeSprite",
                  },
                  {
                    name: "render",
                    children: [
                      {
                        name: "ArrowType",
                      },
                      {
                        name: "EdgeRenderer",
                      },
                      {
                        name: "IRenderer",
                      },
                      {
                        name: "ShapeRenderer",
                      },
                    ],
                  },
                  {
                    name: "ScaleBinding",
                  },
                  {
                    name: "Tree",
                  },
                  {
                    name: "TreeBuilder",
                  },
                ],
              },
              {
                name: "events",
                children: [
                  {
                    name: "DataEvent",
                  },
                  {
                    name: "SelectionEvent",
                  },
                  {
                    name: "TooltipEvent",
                  },
                  {
                    name: "VisualizationEvent",
                  },
                ],
              },
              {
                name: "legend",
                children: [
                  {
                    name: "Legend",
                  },
                  {
                    name: "LegendItem",
                  },
                  {
                    name: "LegendRange",
                  },
                ],
              },
              {
                name: "operator",
                children: [
                  {
                    name: "distortion",
                    children: [
                      {
                        name: "BifocalDistortion",
                      },
                      {
                        name: "Distortion",
                      },
                      {
                        name: "FisheyeDistortion",
                      },
                    ],
                  },
                  {
                    name: "encoder",
                    children: [
                      {
                        name: "ColorEncoder",
                      },
                      {
                        name: "Encoder",
                      },
                      {
                        name: "PropertyEncoder",
                      },
                      {
                        name: "ShapeEncoder",
                      },
                      {
                        name: "SizeEncoder",
                      },
                    ],
                  },
                  {
                    name: "filter",
                    children: [
                      {
                        name: "FisheyeTreeFilter",
                      },
                      {
                        name: "GraphDistanceFilter",
                      },
                      {
                        name: "VisibilityFilter",
                      },
                    ],
                  },
                  {
                    name: "IOperator",
                  },
                  {
                    name: "label",
                    children: [
                      {
                        name: "Labeler",
                      },
                      {
                        name: "RadialLabeler",
                      },
                      {
                        name: "StackedAreaLabeler",
                      },
                    ],
                  },
                  {
                    name: "layout",
                    children: [
                      {
                        name: "AxisLayout",
                      },
                      {
                        name: "BundledEdgeRouter",
                      },
                      {
                        name: "CircleLayout",
                      },
                      {
                        name: "CirclePackingLayout",
                      },
                      {
                        name: "DendrogramLayout",
                      },
                      {
                        name: "ForceDirectedLayout",
                      },
                      {
                        name: "IcicleTreeLayout",
                      },
                      {
                        name: "IndentedTreeLayout",
                      },
                      {
                        name: "Layout",
                      },
                      {
                        name: "NodeLinkTreeLayout",
                      },
                      {
                        name: "PieLayout",
                      },
                      {
                        name: "RadialTreeLayout",
                      },
                      {
                        name: "RandomLayout",
                      },
                      {
                        name: "StackedAreaLayout",
                      },
                      {
                        name: "TreeMapLayout",
                      },
                    ],
                  },
                  {
                    name: "Operator",
                  },
                  {
                    name: "OperatorList",
                  },
                  {
                    name: "OperatorSequence",
                  },
                  {
                    name: "OperatorSwitch",
                  },
                  {
                    name: "SortOperator",
                  },
                ],
              },
              {
                name: "Visualization",
              },
            ],
          },
        ],
      };

      var i = 0,
        duration = 750,
        rectW = 60 * 2 * 2,
        rectH = 30 * 2;

      var tree = d3.layout.tree().nodeSize([70, 40]);
      var diagonal = d3.svg.diagonal().projection(function (d) {
        return [d.x + rectW / 2, d.y + rectH / 2];
      });

      var svg = d3
        .select("#body")
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .call((zm = d3.behavior.zoom().scaleExtent([1, 3]).on("zoom", redraw)))
        .append("g")
        .attr("transform", "translate(" + 350 + "," + 20 + ")");

      //necessary so that zoom knows where to zoom and unzoom from
      zm.translate([350, 20]);

      root.x0 = 0;
      root.y0 = height / 2;

      function collapse(d) {
        if (d.children) {
          d._children = d.children;
          d._children.forEach(collapse);
          d.children = null;
        }
      }

      root.children.forEach(collapse);
      update(root);

      d3.select("#body").style("height", "800px");

      function update(source) {
        // Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
          links = tree.links(nodes);

        // Normalize for fixed-depth.
        nodes.forEach(function (d) {
          d.y = d.depth * 90;
          d.x = d.x * 6;
        });

        // Update the nodes…
        var node = svg.selectAll("g.node").data(nodes, function (d) {
          return d.id || (d.id = ++i);
        });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node
          .enter()
          .append("g")
          .attr("class", "node")
          .attr("transform", function (d) {
            return "translate(" + source.x0 + "," + source.y0 + ")";
          })
          .on("click", click);

        nodeEnter
          .append("rect")
          .attr("width", rectW)
          .attr("height", rectH)
          .attr("stroke", "black")
          .attr("stroke-width", 1)
          .style("fill", function (d) {
            return d._children ? "lightsteelblue" : "#fff";
          });

        nodeEnter
          .append("text")
          .attr("x", rectW / 2)
          .attr("y", rectH / 2)
          .attr("dy", ".35em")
          .attr("text-anchor", "middle")
          .text(function (d) {
            return d.title;
          });

        // Transition nodes to their new position.
        var nodeUpdate = node
          .transition()
          .duration(duration)
          .attr("transform", function (d) {
            console.log("translating in update", d);
            return "translate(" + d.x + "," + d.y + ")";
          });

        nodeUpdate
          .select("rect")
          .attr("width", rectW)
          .attr("height", rectH)
          .attr("stroke", "black")
          .attr("stroke-width", 1)
          .style("fill", function (d) {
            return d._children ? "lightsteelblue" : "#fff";
          });

        nodeUpdate.select("text").style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node
          .exit()
          .transition()
          .duration(duration)
          .attr("transform", function (d) {
            console.log("translating in exit");
            return "translate(" + source.x + "," + source.y + ")";
          })
          .remove();

        nodeExit
          .select("rect")
          .attr("width", rectW)
          .attr("height", rectH)
          //.attr("width", bbox.getBBox().width)""
          //.attr("height", bbox.getBBox().height)
          .attr("stroke", "black")
          .attr("stroke-width", 1);

        nodeExit.select("text");

        // Update the links…
        var link = svg.selectAll("path.link").data(links, function (d) {
          return d.target.id;
        });

        // Enter any new links at the parent's previous position.
        link
          .enter()
          .insert("path", "g")
          .attr("class", "link")
          .attr("x", rectW / 2)
          .attr("y", rectH / 2)
          .attr("d", function (d) {
            var o = {
              x: source.x0,
              y: source.y0,
            };
            return diagonal({
              source: o,
              target: o,
            });
          });

        // Transition links to their new position.
        link.transition().duration(duration).attr("d", diagonal);

        // Transition exiting nodes to the parent's new position.
        link
          .exit()
          .transition()
          .duration(duration)
          .attr("d", function (d) {
            var o = {
              x: source.x,
              y: source.y,
            };
            return diagonal({
              source: o,
              target: o,
            });
          })
          .remove();

        // Stash the old positions for transition.
        nodes.forEach(function (d) {
          d.x0 = d.x;
          d.y0 = d.y;
        });
      }

      // Toggle children on click.
      function click(d) {
        if (d.children) {
          d._children = d.children;
          d.children = null;
        } else {
          d.children = d._children;
          d._children = null;
        }
        update(d);
      }

      //Redraw for zoom
      function redraw() {
        //console.log("here", d3.event.translate, d3.event.scale);
        svg.attr(
          "transform",
          "translate(" +
            d3.event.translate +
            ")" +
            " scale(" +
            d3.event.scale +
            ")"
        );
      }
    </script>
  </body>
</html>
